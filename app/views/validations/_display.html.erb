<%= javascript_include_tag "export" %>
<%= javascript_include_tag "flot/jquery.flot" %>
<%= javascript_include_tag "flot/jquery.flot.errorbars" %>
<%= javascript_include_tag "flot/jquery.flot.axislabels" %>
<%= javascript_include_tag "plots" %>

<script>
$(function() {
  // better way to do this?
  var url = '<%= escape_javascript(validation_project_validation_path(@project, @validation)) %>.json';

  // selector is for tab pane containing div with plot class
  function updatePlots(selector) {
    $(selector).find('.plot').each(function() {
      var $container = $(this);

      // check if there's already a plot there
      if ($container.children().length == 0) {
        var type = $container.data('type');
        $container.spin();
        $.get(url, { data: type }, function(data) {
          $e.plot($container, type, data);
        }, 'json');
      }
    });
  }

  // initial selection
  // need a better selector
  updatePlots($('li.active a').attr('href'));

  // flot has some plotting issues if not visible
  $('a[data-toggle="tab"]').on('shown', function(e) {
    updatePlots($(e.target).attr('href'));
  });
});
</script>


<%= render partial: "shared/toolbar", locals: { text: "Performed validation on #{pluralize(@validation.predicted.size, 'prediction')}.", parent: @project, object: @validation, export_options: ["json"] } %>

<div class="row">
  <div class="span12">
    <div class="tabbable">
      <ul class="nav nav-tabs">
        <li><a href="#vs-tab" data-toggle="tab">Observed vs. predicted</a></li>
        <li class="active"><a href="#standard-score-tab" data-toggle="tab">Standard score</a></li>
        <li><a href="#mean-residual-tab" data-toggle="tab">Mean residual</a></li>
        <li><a href="#median-residual-tab" data-toggle="tab">Median residual</a></li>
        <li><a href="#rank-tab" data-toggle="tab">Rank</a></li>
        <li><a href="#reliability-tab" data-toggle="tab">Reliability</a></li>
        <li><a href="#coverage-tab" data-toggle="tab">Coverage</a></li>
        <li><a href="#metrics-tab" data-toggle="tab">Additional metrics</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="tab-content">
  <div class="tab-pane row" id="vs-tab">
    <div class="span6">
      <div class="plot square" data-type="vs_predicted_mean_plot"></div>
    </div>
    <div class="span6">
      <div class="plot square" data-type="vs_predicted_median_plot"></div>
    </div>
  </div>
  <div class="tab-pane active" id="standard-score-tab">
    <div class="plot" data-type="standard_score_plot"></div>
  </div>
  <div class="tab-pane row" id="mean-residual-tab">
    <div class="span6">
      <div class="plot square" data-type="mean_residual_histogram"></div>
    </div>
    <div class="span6">
      <div class="plot square" data-type="mean_residual_qq_plot"></div>
    </div>
  </div>
  <div class="tab-pane row" id="median-residual-tab">
    <div class="span6">
      <div class="plot square" data-type="median_residual_histogram"></div>
    </div>
    <div class="span6">
      <div class="plot square" data-type="median_residual_qq_plot"></div>
    </div>
  </div>
  <div class="tab-pane" id="rank-tab">
    <div class="plot" data-type="rank_histogram"></div>
  </div>
  <div class="tab-pane" id="reliability-tab">
    <div class="plot square" data-type="reliability_diagram"></div>
  </div>
  <div class="tab-pane" id="coverage-tab">
    <div class="plot square" data-type="coverage_plot"></div>
  </div>
  <div class="tab-pane" id="metrics-tab">
    <div class="row">
      <div class="span6">
        <table border="1" class="metrics">
          <tr>
            <th colspan="2">Mean</th>
          </tr>
          <tr>
            <td>Bias</td>
            <td><%= number_with_precision(@validation.mean_bias, precision: 3) %></td>
          </tr>
          <tr>
            <td>Mean absolute error</td>
            <td><%= number_with_precision(@validation.mean_mae, precision: 3) %></td>
          </tr>
          <tr>
            <td>Root-mean-square error</td>
            <td><%= number_with_precision(@validation.mean_rmse, precision: 3) %></td>
          </tr>
          <tr>
            <td>Correlation</td>
            <td><%= number_with_precision(@validation.mean_correlation, precision: 3) %></td>
          </tr>
        </table>
      </div>
      <div class="span6">
        <table border="1" class="metrics">
          <tr>
            <th colspan="2">Median</th>
          </tr>
          <tr>
            <td>Bias</td>
            <td><%= number_with_precision(@validation.median_bias, precision: 3) %></td>
          </tr>
          <tr>
            <td>Mean absolute error</td>
            <td><%= number_with_precision(@validation.median_mae, precision: 3) %></td>
          </tr>
          <tr>
            <td>Root-mean-square error</td>
            <td><%= number_with_precision(@validation.median_rmse, precision: 3) %></td>
          </tr>
          <tr>
            <td>Correlation</td>
            <td><%= number_with_precision(@validation.median_correlation, precision: 3) %></td>
          </tr>
        </table>
      </div>
    </div>
    <div class="row">
      <div class="span4">
        <table border="1" class="metrics">
          <tr>
            <th colspan="2">Continuous Ranked Probability Score</th>
          </tr>
          <tr>
            <td>Score</td>
            <td><%= number_with_precision(@validation.crps, precision: 3) %></td>
          </tr>
          <tr>
            <td>Reliability</td>
            <td><%= number_with_precision(@validation.crps_reliability, precision: 3) %></td>
          </tr>
          <tr>
            <td>Resolution</td>
            <td><%= number_with_precision(@validation.crps_resolution, precision: 3) %></td>
          </tr>
          <tr>
            <td>Uncertainty</td>
            <td><%= number_with_precision(@validation.crps_uncertainty, precision: 3) %></td>
          </tr>
        </table>
      </div>
      <div class="span4">
        <table border="1" class="metrics">
          <tr>
            <th colspan="2">Ignorance Score</th>
          </tr>
          <tr>
            <td>Score</td>
            <td><%= number_with_precision(@validation.ign_score, precision: 3) %></td>
          </tr>
          <tr>
            <td>Reliability</td>
            <td><%= number_with_precision(@validation.ign_reliability, precision: 3) %></td>
          </tr>
          <tr>
            <td>Resolution</td>
            <td><%= number_with_precision(@validation.ign_resolution, precision: 3) %></td>
          </tr>
          <tr>
            <td>Uncertainty</td>
            <td><%= number_with_precision(@validation.ign_uncertainty, precision: 3) %></td>
          </tr>
        </table>
      </div>
      <div class="span4">
        <table border="1" class="metrics">
          <tr>
            <th colspan="2">Brier Score</th>
          </tr>
          <tr>
            <td>Score</td>
            <td><%= number_with_precision(@validation.brier_score, precision: 3) %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>